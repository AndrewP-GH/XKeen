#!/bin/sh

# Определение директории, где находится xkeen.sh
script_dir="$(cd "$(dirname "$0")" && pwd)"

# Скрываем основную директорию xkeen
install_xkeen_rename() {
    script_dir="$script_dir"
    source_dir="_xkeen"
    target_dir=".xkeen"
    source_path="$script_dir/$source_dir"
    target_path="$script_dir/$target_dir"
    
    if [ -d "$source_path" ]; then
        if [ -d "$target_path" ]; then
            rm -rf "$target_path"
        fi
        mv "$source_path" "$target_path"
    fi
}

install_xkeen_rename

# Импортируем модули
. "$script_dir/.xkeen/import.sh"

# Очищаем журнал перед работой
	logs_clear
	
# Проверяем установку пакетов
	info_packages
	logs_packages_info_xkeen

# Собираем необходимую информацию о процессоре
	info_cpu
	logs_cpu_info_xkeen
	
# Проверяем установку xray
	info_xray
	logs_xray_info_xkeen

# Проверяем установленные базы geosite
	info_geosite
	logs_geosite_info_xkeen
	
# Проверяем установленные базы geoip
	info_geoip
	logs_geoip_info_xkeen

# Проверяем статусы автоматических обновлений
	info_cron
	logs_cron_info_xkeen

# Проверяем версию xkeen
	info_version_xkeen
	logs_version_xkeen_info_xkeen

# Проверяем актуальность xkeen
	info_compare_xkeen
	logs_compare_xkeen_info_xkeen
	
# Проверяем версию xray
	info_version_xray
	logs_version_xray_info_xkeen

# Проверяем актуальность xray
	info_compare_xray
	logs_compare_xray_info_xkeen

# Устанавливаем недостающие пакеты
	install_packages
	logs_install_packages_xkeen

	
while [ $# -gt 0 ]; do
    case "$1" in
	
        -i)	# Запуск полного цикла установки
			# Устанавливаем xray			
			eval "clear"	
				if [ "$xray_installed" = "not_installed" ]; then
					download_xray
					logs_download_xray_info_xkeen
					
					install_xray
					
					xray_installed="installed"
				fi
				
			eval "clear" 
			# Обновляем xray	
				if [ "$info_compare_xray" = "update" ]; then
					download_xray
					logs_download_xray_info_xkeen
					
					install_xray
					
					xray_current_version="actual"
				fi
				
			eval "clear" 
			logs_cpu_console
			# Устанавливаем geoip
				choose_geoip
				logs_choose_geoip_info_xkeen
				
					delete_geoip
					logs_delete_geoip_info_xkeen
					
					install_geoip
					logs_install_geoip_info_xkeen
					
			eval "clear" 
			# Устанавливаем geosite
				choose_geosite
				logs_choose_geosite_info_xkeen
				
					delete_geosite
					logs_delete_geosite_info_xkeen
										
					install_geosite
					logs_install_geosite_info_xkeen
						
			eval "clear" 
			# Настраиваем автоматические обновления
				choose_update_cron
				logs_choose_update_cron_info_xkeen
				
			eval "clear" 
				choose_cron_time
				logs_choose_cron_time_info_xkeen
				
					delete_cron_task
					logs_delete_cron_task_info_xkeen
					
			#	choose_cron_time
					install_cron
					logs_install_cron_info_xkeen
							
			eval "clear" 
			# Устанавливаем configs xray
				install_configs
				logs_install_configs_info_xkeen
								
			# Удаляем предыдущие регистрации
				delete_register_xkeen
				logs_delete_register_xkeen_info_xkeen
								
				delete_register_xray
				logs_delete_register_xray_info_xkeen
								
			# Регистрируем xray
				register_xray_list
				logs_register_xray_list_info_xkeen
				
				register_xray_control
				logs_register_xray_control_info_xkeen
				
				register_xray_status
				logs_register_xray_status_info_xkeen
				
				register_xray_initd
				logs_register_xray_initd_info_xkeen
				

			# Регистрируем xkeen
				register_xkeen_list
				logs_register_xray_list_info_xkeen
				
				register_xkeen_control
				logs_register_xray_control_info_xkeen
				
				register_xkeen_status
				logs_register_xkeen_status_info_xkeen
				

			# Удаляем временные файлы
				delete_tmp
				logs_delete_tmp_info_xkeen
				
            shift
            ;;
			
        -ux)		#Запуск обновления xray
			if [ "$info_compare_xray" = "update" ]; then
				eval "/opt/etc/init.d/S24xray stop"
				
				backup_xray
				
				download_xray
				logs_download_xray_info_xkeen
				
				install_xray
				
				delete_register_xray
				logs_delete_register_xray_info_xkeen
				logs_delete_register_xray_info_console
				
				register_xray_list
				logs_register_xray_list_info_xkeen
				logs_register_xray_list_info_console
				
				register_xray_control
				logs_register_xray_control_info_xkeen
				logs_register_xray_control_info_console
				
				register_xray_status
				logs_register_xray_status_info_xkeen
				logs_register_xray_status_info_console
				
				eval "/opt/etc/init.d/S24xray start"
				
				delete_tmp
				logs_delete_tmp_info_xkeen
			fi
            shift
            ;;
			
			
        -uk)		#Запуск обновления xkeen
			if [ "$info_compare_xkeen" = "update" ]; then
				backup_xkeen	
				
				download_xkeen
				logs_download_xkeen_info_xkeen
				
				install_xkeen
				
				delete_register_xkeen
				logs_delete_register_xkeen_info_xkeen
				logs_delete_register_xkeen_info_console

				
				register_xkeen_list
				logs_register_xkeen_list_info_xkeen
				logs_register_xkeen_list_info_console
				
				register_xkeen_control
				logs_register_xkeen_control_info_xkeen
				logs_register_xkeen_control_info_console
				
				register_xkeen_status
				logs_register_xkeen_status_info_xkeen
				logs_register_xkeen_status_info_console
				
				delete_tmp
				logs_delete_tmp_info_xkeen
			fi
            shift
            ;;
						
        -ugs)	#Запуск обновления баз geosite		
			eval "/opt/etc/init.d/S24xray stop"
			
			if [ "$geo_exists_geosite_v2fly" = "installed" ]; then
				install_v2fly_geosite="true"
            fi
			
			if [ "$geo_exists_geosite_antifilter" = "installed" ]; then
                install_antifilter_geosite="true"
            fi
						
			if [ "$geo_exists_geosite_antizapret" = "installed" ]; then
				install_antizapret_geosite="true"
            fi
				
				install_geosite
				logs_install_geosite_info_xkeen
				logs_install_geosite_info_console
				
			eval "/opt/etc/init.d/S24xray start"
            shift
            ;;
			
			
        -ugi)		#Запуск обновления баз geoip
			eval "/opt/etc/init.d/S24xray stop"
			
			if [ "$geo_exists_geoip_v2fly" = "installed" ]; then
				install_v2fly_geoip="true"
            fi
			
			if [ "$geo_exists_geoip_antifilter" = "installed" ]; then
                install_antifilter_geoip="true"
            fi
				
				install_geoip
				logs_install_geoip_info_xkeen
				logs_install_geoip_info_console
				
				
			eval "/opt/etc/init.d/S24xray start"
            shift
            ;;
			
			
		-uac)	#Создать или изменить существующие правила автоматического обновления Xkeen, Xray, GeoIP, GeoSite	
				delete_cron_xkeen 2>/dev/null
				delete_cron_xray 2>/dev/null
				delete_cron_geoip 2>/dev/null
				delete_cron_geosite 2>/dev/null
				
                    chose_xkeen_cron_select=true
                    chose_xray_cron_select=true
                    chose_geosite_cron_select=true
                    chose_geoip_cron_select=true

				if input_concordance_list "Хотите установить единое время для всех обновлений?"; then
                        chose_all_cron_select=true
                        chose_xkeen_cron_select=false
                        chose_xray_cron_select=false
                        chose_geosite_cron_select=false
                        chose_geoip_cron_select=false
                    else
                        chose_all_cron_select=false
				fi
					
				choose_cron_time
				logs_choose_cron_time_info_xkeen
				
				install_cron
				logs_install_cron_info_xkeen
				logs_install_cron_info_console
            shift
            ;;
			
			
		-ukc)	#Создать или изменить существующее правило автоматического обновления xkeen
				delete_cron_xkeen
				logs_delete_cron_xkeen_info_xkeen
				
				chose_xkeen_cron_select=true
				
				choose_cron_time
				logs_choose_cron_time_info_xkeen
				
				install_cron
				logs_install_cron_info_xkeen
				logs_install_cron_info_console
            shift
            ;;
			
			
		-uxc)	#Создать или изменить существующее правило автоматического обновления xray
				delete_cron_xray
				logs_delete_cron_xray_info_xkeen
				
				chose_xray_cron_select=true
				
				choose_cron_time
				logs_choose_cron_time_info_xkeen
				
				install_cron
				logs_install_cron_info_xkeen
				logs_install_cron_info_console
            shift
            ;;
			
			
		-ugsc)	#Создать или изменить существующее правило автоматического обновления geosite
				delete_cron_geosite
				logs_delete_cron_geosite_info_xkeen
				
				chose_geosite_cron_select=true
				
				choose_cron_time
				logs_choose_cron_time_info_xkeen
				
				install_cron
				logs_install_cron_info_xkeen
				logs_install_cron_info_console
            shift
            ;;
			
			
		-ugic)	#Создать или изменить существующее правило автоматического обновления geoip
				delete_cron_geoip
				logs_delete_cron_geoip_info_xkeen
				
				chose_geoip_cron_select=true
				
				choose_cron_time
				logs_choose_cron_time_info_xkeen
				
				install_cron
				logs_install_cron_info_xkeen
				logs_install_cron_info_console
            shift
            ;;


		-rx)	#Зарегистрировать xray
				delete_register_xray
				logs_delete_register_xray_info_xkeen
				logs_delete_register_xray_info_console
				
				
				register_xray_list
				logs_register_xray_list_info_xkeen
				logs_register_xray_list_info_console
				
				register_xray_control
				logs_register_xray_control_info_xkeen
				logs_register_xray_control_info_console
				
				register_xray_status
				logs_register_xray_status_info_xkeen
				logs_register_xray_status_info_console
            shift
            ;;
			

		-ri)	#Создать правило автоматического запуска xkeen
				eval "/opt/etc/init.d/S24xray stop"
				
				register_xray_initd
				logs_register_xray_initd_info_xkeen
				logs_register_xray_initd_info_console
				
				eval "/opt/etc/init.d/S24xray start"
            shift
            ;;
			

		-rk)	#Зарегистрировать xkeen
				delete_register_xkeen				
				logs_delete_register_xkeen_info_xkeen
				logs_delete_register_xkeen_info_console
				
				register_xkeen_list
				logs_register_xkeen_list_info_xkeen
				logs_register_xkeen_list_info_console
				
				register_xkeen_control
				logs_register_xkeen_control_info_xkeen
				logs_register_xkeen_control_info_console
				
				register_xkeen_status
				logs_register_xkeen_status_info_xkeen
				logs_register_xkeen_status_info_console
            shift
            ;;
			

			
		-dac)	#Удалить правила автоматического обновления Xkeen, Xray, GeoSite, GeoIP
				delete_cron_xkeen
				delete_cron_xray
				delete_cron_geosite
				delete_cron_geoip
				logs_delete_cron_task_info_xkeen
				logs_delete_cron_task_info_console
            shift
            ;;
			
			
		-dkc)		#Удалить правило автоматического обновления xkeen
				delete_cron_xkeen
				logs_delete_cron_xkeen_info_xkeen
				logs_delete_cron_xkeen_info_console
            shift
            ;;
			

		-dxc)		#Удалить правило автоматического обновления xray
				delete_cron_xray
				logs_delete_cron_xray_info_xkeen
				logs_delete_cron_xray_info_console
            shift
            ;;
			

		-dgsc)		#Удалить правило автоматического обновления geosite
				delete_cron_geosite
				logs_delete_cron_geosite_info_xkeen
				logs_delete_cron_geosite_info_console
            shift
            ;;
			
			
		-dgic)		#Удалить правило автоматического обновления geoip
				delete_cron_geoip
				logs_delete_cron_geoip_info_xkeen
				logs_delete_cron_geoip_info_console
            shift
            ;;
			
			
		-dx)	#Удалить xray
				eval "/opt/etc/init.d/S24xray stop"
				eval "opkg remove xray"
            shift
            ;;
			
			
		-dk)	#Удалить xkeen
				eval "opkg remove xkeen"
            shift
            ;;
			
			
		-dgs)	#Удалить базы geosite
				eval "/opt/etc/init.d/S24xray stop"
				
				delete_geosite_key
				logs_delete_geosite_info_xkeen
				logs_delete_geosite_info_console
				
				eval "/opt/etc/init.d/S24xray start"
            shift
            ;;
			
			
		-dgi)	#Удалить базы geoip
				val "/opt/etc/init.d/S24xray stop"
				
				delete_geoip_key
				logs_delete_geoip_info_xkeen
				logs_delete_geoip_info_console
				
				eval "/opt/etc/init.d/S24xray start"
            shift
            ;;
			
			
		-dt)	#Удалить временные файлы xkeen
				delete_tmp
				logs_delete_tmp_info_xkeen
            shift
            ;;
			
			
		-dс)	#Удалить все конфиги xray
				delete_configs
				logs_delete_configs_info_console
				logs_delete_configs_info_xkeen				
            shift
            ;;
			
			
		-drx)	#Удалить регистрации xray
				delete_register_xray
				logs_delete_register_xray_info_xkeen
            shift
            ;;
			

		-drk)	#Удалить регистрации xkeen
				delete_register_xkeen
				logs_delete_register_xkeen_info_xkeen
				logs_delete_register_xkeen_info_console
            shift
            ;;


		-rrk)	#Обновить регистрацию xkeen
				delete_register_xkeen
				logs_delete_register_xkeen_info_xkeen
				logs_delete_register_xkeen_info_console
				
				register_xkeen_list
				logs_register_xkeen_list_info_xkeen
				logs_register_xkeen_list_info_console
				
				register_xkeen_control
				logs_register_xkeen_control_info_xkeen
				logs_register_xkeen_control_info_console
				
				register_xkeen_status
				logs_register_xkeen_status_info_xkeen
				logs_register_xkeen_status_info_console
				
            shift
            ;;
			
			
		-rrx)	#Обновить регистрацию xray
				delete_register_xray
				logs_delete_register_xray_info_xkeen
				logs_delete_register_xray_info_console
				
				register_xray_list
				logs_register_xray_list_info_xkeen
				logs_register_xray_list_info_console
				
				register_xray_control
				logs_register_xray_control_info_xkeen
				logs_register_xray_control_info_console
				
				register_xray_status
				logs_register_xray_status_info_xkeen
				logs_register_xray_status_info_console
            shift
            ;;
				
			
		-rc)	#Переустановить конфиги xray
				install_configs
				logs_install_configs_info_xkeen
				logs_install_configs_info_console
				
				delete_register_xray
				logs_delete_register_xray_info_xkeen
				logs_delete_register_xray_info_console
				
				register_xray_list
				logs_register_xray_list_info_xkeen
				logs_register_xray_list_info_console
				
				register_xray_control
				logs_register_xray_control_info_xkeen
				logs_register_xray_control_info_console
				
				register_xray_status
				logs_register_xray_status_info_xkeen
				logs_register_xray_status_info_console
            shift
            ;;
			
			
		-x)	#Переустановить xray
				eval "opkg remove xray" 
				xray_installed="not_installed"
				
				download_xray
				logs_download_xray_info_xkeen
				
				install_xray
				xray_installed="installed"
				
				install_configs
				logs_install_configs_info_xkeen
				logs_install_configs_info_console
				
				
				delete_register_xray
				logs_delete_register_xray_info_xkeen
				logs_delete_register_xray_info_console
				
				register_xray_list
				logs_register_xray_list_info_xkeen
				logs_register_xray_list_info_console
				
				register_xray_control
				logs_register_xray_control_info_xkeen
				logs_register_xray_control_info_console
				
				register_xray_status
				logs_register_xray_status_info_xkeen
				logs_register_xray_status_info_console
				
				if input_concordance_list "Хотите включить автоматическое обновление xray?"; then
                        chose_xray_cron_select=true
                    else
                        chose_xray_cron_select=false
				fi
				
				choose_cron_time
				logs_choose_cron_time_info_xkeen
				
				install_cron
				logs_install_cron_info_xkeen
				logs_install_cron_info_console
								
            shift
            ;;
			
			
		-k)	#Переустановить xkeen
				
				download_xkeen
				logs_download_xkeen_info_xkeen
				
				install_xkeen
				
				delete_register_xkeen
				logs_delete_register_xkeen_info_xkeen
				logs_delete_register_xkeen_info_console
										
				register_xkeen_list
				logs_register_xkeen_list_info_xkeen
				logs_register_xkeen_list_info_console
				
				register_xkeen_control
				logs_register_xkeen_control_info_xkeen
				logs_register_xkeen_control_info_console
				
				register_xkeen_status
				logs_register_xkeen_status_info_xkeen
				logs_register_xkeen_status_info_console
				
				if input_concordance_list "Хотите включить автоматическое обновление xkeen?"; then
                        chose_xkeen_cron_select=true
                    else
                        chose_xkeen_cron_select=false
				fi
				
				choose_cron_time
				logs_choose_cron_time_info_xkeen
				
				install_cron
				logs_install_cron_info_xkeen
				logs_install_cron_info_console
								
				delete_tmp
				logs_delete_tmp_info_xkeen
								
            shift
            ;;
			
		-xb)	#Сделать резервную копию xray
				backup_xray								
            shift
            ;;
						
		-kb)	#Резервное копирование xkeen
				backup_xkeen		
            shift
            ;;
			
		-cb)	#Сделать резервную конфигураций xray
				backup_configs						
            shift
            ;;
						
		-xbr)	# Восстановление резервной копировании xray
				restore_backup_xray								
            shift
            ;;
			
			
		-kbr)	# Восстановление резервной копировании xkeen
				restore_backup_xkeen		
            shift
            ;;
			
		-cbr)	# Восстановление резервной копировании конфигурационных файлов xray
				restore_backup_configs						
            shift
            ;;
			
						
		-connect)	# Тест соединения
				tests_connection
				
            shift
            ;;
			
		-portx)	# Показать прослушиваемые порты
				tests_ports_xray
			;;
			
		-ad)	# Можете купить Мне кофе
				author_donate					
            shift
            ;;
			
		-af)	# Обратная связь
				author_feedback			
            shift
            ;;
			
		-start)	# Запуск Xray
				eval "/opt/etc/init.d/S24xray start" 
				sleep 2
				exec "$SHELL"
				
            shift
            ;;	
			
		-stop)	# Остановка Xray
				eval "/opt/etc/init.d/S24xray stop" 
				sleep 2
				exec "$SHELL"
				
            shift
            ;;		
			
		-restart)	# Перезапуск Xray
				eval "/opt/etc/init.d/S24xray restart" 
				sleep 2
				exec "$SHELL"
				
            shift
            ;;				
			
		-status)	# Проверка Xray
				eval "/opt/etc/init.d/S24xray status" 
				
            shift
            ;;		
			
		-arch)	# Подготавливает текущую сборку для релиза
				archive_xkeen
				
            shift
            ;;
			
		-h)	#Помощь			
				echo
				echo -e "     ${light_blue}xkeen${reset} — утилита для обеспечения работы xray на роутерах keenetic"
				echo 
				echo -e "     Пример использования ключей запуска: «xkeen ${green}-x${reset}», где ${green}-x${reset} — выбранный Вами ключ."
				echo "     Список доступных ключей запуска"
				echo
				echo -e "  ${yellow}Полный цикл установки${reset}"
				echo -e "     ${green}-i${reset} — Необходимые пакеты, Xray и сервисы Xkeen"
				echo 
				echo -e "  ${yellow}Обновление${reset}"
				echo -e "     ${green}-ux${reset} — Xray"
				echo -e "     ${green}-uk${reset} — Xkeen"
				echo -e "     ${green}-ugs${reset} — GeoSite"
				echo -e "     ${green}-ugi${reset} — GeoIP"
				echo 
				echo -e "  ${yellow}Включение или изменение правил обновления${reset}"
				echo -e "     ${green}-uac${reset} — Xray, Xkeen, GeoSite, GeoIP"
				echo -e "     ${green}-uxc${reset} — Xray"
				echo -e "     ${green}-ukc${reset} — Xkeen"
				echo -e "     ${green}-ugsc${reset} — GeoSite"
				echo -e "     ${green}-ugic ${reset}— GeoIP"
				echo 
				echo -e "  ${yellow}Регистрация${reset}"
				echo -e "     ${green}-rx${reset} — Xray"
				echo -e "     ${green}-rk${reset} — Xkeen"
				echo -e "     ${green}-ri${reset} — Автоматический запуск Xray средствами init.d"
				echo 
				echo -e "  ${red}Удаление${reset}  /  Автоматические обновления"
				echo -e "     ${green}-dac${reset} — Xray, Xkeen, GeoSite, GeoIP"
				echo -e "     ${green}-dkc${reset} — Xkeen"
				echo -e "     ${green}-dxc${reset} — Xray"
				echo -e "     ${green}-dgsc${reset} — GeoSite"
				echo -e "     ${green}-dgic${reset} — GeoIP"
				echo
				echo -e "  ${red}Удаление${reset}  /  Утилиты и компоненты"
				echo -e "     ${green}-dx${reset} — Xray"
				echo -e "     ${green}-dk${reset} — Xkeen"
				echo -e "     ${green}-dgs${reset} — GeoSite"
				echo -e "     ${green}-dgi${reset} — GeoIP"
				echo -e "     ${green}-dс${reset} — Конфигурации Xray"
				echo -e "     ${green}-dt${reset} — Временные файлы"
				echo
				echo -e "  ${red}Удаление${reset}  /  Регистрации"			
				echo -e "     ${green}-drx${reset} —  Xray"
				echo -e "     ${green}-drk${reset} — Xkeen"
				echo
				echo -e "  ${yellow}Обновление регистрации утилит${reset}"			
				echo -e "     ${green}-rrx${reset} —  Xray"
				echo -e "     ${green}-rrk${reset} — Xkeen"
				echo
				echo -e "  ${yellow}Переустановка${reset}"		
				echo -e "     ${green}-x${reset} — Xray"
				echo -e "     ${green}-k${reset} — Xkeen"
				echo -e "     ${green}-rc${reset} — Конфигурационные файлы Xray"
				echo
				echo -e "  ${yellow}Резервные копии${reset} / Создание"
				echo -e "     ${green}-xb${reset} — Xray"
				echo -e "     ${green}-kb${reset} — Xkeen"
				echo -e "     ${green}-cb${reset} — Конфигурационные файлов Xray"
				echo
				echo -e "  ${yellow}Резервные копии${reset} / Восстановление последней"
				echo -e "     ${green}-xbr${reset} — Xray"
				echo -e "     ${green}-kbr${reset} — Xkeen"
				echo -e "     ${green}-cbr${reset} — Конфигурационные файлы Xray"
				echo
				echo -e "  ${yellow}Управление Xray${reset}"
				echo -e "     ${green}-start${reset} — Запуск Xray"
				echo -e "     ${green}-stop${reset} — Остановить Xray"
				echo -e "     ${green}-restart${reset} — Перезапустить Xray"
				echo -e "     ${green}-status${reset} — Показать текущий статус работы Xray"
				echo
				echo -e "  ${yellow}Автор${reset}"
				echo -e "     ${green}-ad${reset} — Если Вам полезна утилита, можете купить Мне кофе"
				echo -e "     ${green}-af${reset} — Обратная связь"
				echo
            shift
            ;;
			
        *)
            echo -e "     Неизвестный ключ: ${red}$1${reset}"
            shift
            ;;
			
    esac
done